import { useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Progress } from "@/components/ui/progress";
import { AudioPlayer } from "@/components/audio-player";
import { MicOff, Video, Download, Star, Play, Settings, Zap } from "lucide-react";
import { Slider } from "@/components/ui/slider";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
import { useQuery } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import type { Model, InsertGeneratedContent } from "@shared/schema";

export default function VideoEditor() {
  const [inputText, setInputText] = useState("");
  const [selectedCharacterModelId, setSelectedCharacterModelId] = useState<string>("");
  const [emotion, setEmotion] = useState("neutral");
  const [voiceGenerationType, setVoiceGenerationType] = useState<"basic_tts" | "voice_model" | "voice_clone">("basic_tts");
  const [selectedTTSProvider, setSelectedTTSProvider] = useState("edgetts");
  const [selectedTTSModel, setSelectedTTSModel] = useState("zh-CN-XiaoxiaoNeural"); // Ë®≠ÁΩÆÈ†êË®≠ËÅ≤Èü≥
  const [referenceAudio, setReferenceAudio] = useState<File | null>(null);
  const [generatingAudio, setGeneratingAudio] = useState(false);
  const [generatingVideo, setGeneratingVideo] = useState(false);
  const [audioProgress, setAudioProgress] = useState(0);
  const [videoProgress, setVideoProgress] = useState(0);
  const [generatedAudio, setGeneratedAudio] = useState<string | null>(null);
  const [generatedAudioId, setGeneratedAudioId] = useState<string | null>(null);
  const [generatedVideo, setGeneratedVideo] = useState<string | null>(null);
  const [generatedVideoId, setGeneratedVideoId] = useState<string | null>(null);
  const [selectedVoiceModelId, setSelectedVoiceModelId] = useState<string>("");
  const [selectedGeneratedAudioId, setSelectedGeneratedAudioId] = useState<string>("");

  // MiniMax ÈÄ≤ÈöéÊéßÂà∂
  const [minimaxEmotion, setMinimaxEmotion] = useState("neutral");
  const [minimaxVolume, setMinimaxVolume] = useState([1.0]);
  const [minimaxSpeed, setMinimaxSpeed] = useState([1.0]);
  const [minimaxPitch, setMinimaxPitch] = useState([0]);
  const [showMinimaxAdvanced, setShowMinimaxAdvanced] = useState(false);

  // ATEN ÈÄ≤ÈöéÊéßÂà∂
  const [showATENAdvanced, setShowATENAdvanced] = useState(false);
  const [atenPitch, setAtenPitch] = useState([0]);
  const [atenRate, setAtenRate] = useState([1.0]);
  const [atenVolume, setAtenVolume] = useState([0]);
  const [atenSilenceScale, setAtenSilenceScale] = useState([1.0]);

  const { toast } = useToast();
  const queryClient = useQueryClient();

  // Êî∂Ëóè/ÂèñÊ∂àÊî∂Ëóè
  const toggleFavoriteMutation = useMutation({
    mutationFn: async ({ id, isFavorite }: { id: string; isFavorite: boolean }) => {
      const response = await apiRequest("PATCH", `/api/content/${id}/favorite`, { isFavorite });
      return response.json();
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ["/api/content"] });
      toast({
        title: data.message,
        description: data.data.isFavorite ? "Â∑≤Âä†ÂÖ•Êî∂Ëóè" : "Â∑≤ÂèñÊ∂àÊî∂Ëóè",
      });
    },
    onError: () => {
      toast({
        title: "Êìç‰ΩúÂ§±Êïó",
        description: "Ë´ãÁ®çÂæåÈáçË©¶",
        variant: "destructive",
      });
    },
  });

  const { data: modelsResponse } = useQuery({
    queryKey: ["/api/models"],
    queryFn: async () => {
      const response = await apiRequest("GET", "/api/models");
      return response.json();
    },
  });

  const models = modelsResponse?.data?.list || [];
  const characterModels = models.filter((m: Model) => m.type === "character" && m.status === "ready");

  // TTS Êèê‰æõÂïÜ
  const ttsProviders = [
    { id: "edgetts", name: "EdgeTTS (ÂæÆËªü)", description: "ÂÖçË≤ªÔºåÂ§öË™ûË®ÄÊîØÊè¥" },
    { id: "minimax", name: "MiniMax", description: "‰ªòË≤ªÔºåÈ´òÂìÅË≥™‰∏≠ÊñáÔºåÊîØÊè¥ÊÉÖÁ∑íÊéßÂà∂" },
    { id: "aten", name: "ATEN AIVoice", description: "Â∞àÊ•≠Á¥öË™ûÈü≥ÂêàÊàêÔºåÊîØÊè¥‰∏≠Êñá„ÄÅËã±Êñá„ÄÅÂè∞Ë™û" },
    { id: "fishtts", name: "FishTTS", description: "ÈñãÊ∫êÔºåÂèØËá™Ë®ìÁ∑¥" },
  ];

  // TTS ËÅ≤Èü≥ÈÅ∏È†Ö
  const ttsVoices = {
    edgetts: [
      { id: "zh-CN-XiaoxiaoNeural", name: "ÊõâÊõâ (Ê∫´ÊüîÂ•≥ËÅ≤)", language: "zh-CN" },
      { id: "zh-CN-YunxiNeural", name: "Èõ≤Â∏å (Ê¥ªÊΩëÁî∑ËÅ≤)", language: "zh-CN" },
      { id: "zh-CN-XiaoyiNeural", name: "Êõâ‰ºä (ÁîúÁæéÂ•≥ËÅ≤)", language: "zh-CN" },
      { id: "zh-CN-YunjianNeural", name: "Èõ≤ÂÅ• (Ê≤âÁ©©Áî∑ËÅ≤)", language: "zh-CN" },
      { id: "en-US-JennyNeural", name: "Jenny (ÁæéÂºèÂ•≥ËÅ≤)", language: "en-US" },
      { id: "en-US-GuyNeural", name: "Guy (ÁæéÂºèÁî∑ËÅ≤)", language: "en-US" },
    ],
    minimax: [
      { id: "moss_audio_069e7ef7-45ab-11f0-b24c-2e48b7cbf811", name: "Â∞èÂÆâ (Â•≥)", language: "zh-CN" },
      { id: "moss_audio_e2651ab2-50e2-11f0-8bff-3ee21232901d", name: "Â∞èË≥¥ (Áî∑)", language: "zh-CN" },
      { id: "moss_audio_9e3d9106-42a6-11f0-b6c4-9e15325fe584", name: "Hayley (Â•≥)", language: "zh-CN" },
    ],
    aten: [
      // Áî∑ËÅ≤ËÅ≤ÂÑ™
      { id: "Aaron", name: "Ê≤âÁ©©Áî∑ËÅ≤-Ë£ïÁ••", language: "zh-TW" },
      { id: "Shawn", name: "ÊñØÊñáÁî∑ËÅ≤-‰øäÊòá", language: "zh-TW" },
      { id: "Jason", name: "Ëá™Âú®Áî∑ËÅ≤-Â±ïÊ≤≥", language: "zh-TW" },
      { id: "Winston_narrative", name: "ÊÇ†ÁÑ∂Áî∑ËÅ≤-Â±ïÊèö", language: "zh-TW" },
      { id: "Alan_colloquial", name: "Á©©ÂÅ•Áî∑ËÅ≤-Â±ï‰ªÅ", language: "zh-TW" },
      { id: "Waldo_Ad", name: "Âª£ÂëäÁî∑ËÅ≤-Â±ïÈæç", language: "zh-TW" },
      { id: "Bill_cheerful", name: "Ê¥ªÂäõÁî∑ËÅ≤-ÂäõÊô®", language: "zh-TW" },
      { id: "Eason_broadcast", name: "Âª£Êí≠Áî∑ËÅ≤-Â±ïÂÆè", language: "zh-TW" },
      
      // Â•≥ËÅ≤ËÅ≤ÂÑ™
      { id: "Bella_host", name: "Âãï‰∫∫Â•≥ËÅ≤-Ë≤ùÊãâ", language: "zh-TW" },
      { id: "Bella_vivid", name: "ÈñãÊúóÂ•≥ËÅ≤-Ë≤ùÊãâ", language: "zh-TW" },
      { id: "Rena", name: "Ê∫´ÂíåÂ•≥ËÅ≤-ÊÄùÊüî", language: "zh-TW" },
      { id: "Hannah_colloquial", name: "Ëá™Âú®Â•≥ËÅ≤-ÊÄùÊ∂µ", language: "zh-TW" },
      { id: "Michelle_colloquial", name: "ÊÇ†ÁÑ∂Â•≥ËÅ≤-ÊÄùÂ©∑", language: "zh-TW" },
      { id: "Celia_call_center", name: "ÂÆ¢ÊúçÂ•≥ËÅ≤-ÊÄùÁê™", language: "zh-TW" },
      { id: "Hannah_news", name: "Áü•ÊÄßÂ•≥ËÅ≤-ÊÄùÊ∂µ", language: "zh-TW" },
      { id: "Aurora", name: "Á©©ÈáçÂ•≥ËÅ≤-ÂòâÂ¶Æ", language: "zh-TW" },
      
      // Âè∞Ë™ûËÅ≤ÂÑ™
      { id: "Easton_news", name: "Âè∞Ë™ûÁî∑ËÅ≤-ÊñáÈõÑ", language: "TL" },
      { id: "Raina_narrative", name: "Âè∞Ë™ûÂ•≥ËÅ≤-ÊÄùÁæΩ", language: "TL" },
      { id: "Winston_narrative_taigi", name: "Âè∞Ë™ûÊÇ†ÁÑ∂Áî∑ËÅ≤-Â±ïÊèö", language: "TL" },
      { id: "Celia_call_center_taigi", name: "Âè∞Ë™ûÂÆ¢ÊúçÂ•≥ËÅ≤-ÊÄùÁê™", language: "TL" },
    ],
    fishtts: [
      { id: "default", name: "È†êË®≠ËÅ≤Èü≥", language: "zh-CN" },
    ],
  };

  // MiniMax ÊÉÖÁ∑íÈÅ∏È†Ö
  const minimaxEmotions = [
    { id: "neutral", name: "‰∏≠ÊÄß" },
    { id: "happy", name: "ÈñãÂøÉ" },
    { id: "sad", name: "ÊÇ≤ÂÇ∑" },
    { id: "angry", name: "ÊÜ§ÊÄí" },
    { id: "surprised", name: "È©öË®ù" },
    { id: "calm", name: "Âπ≥Èùú" },
  ];

  const generateAudioMutation = useMutation({
    mutationFn: async (data: any) => {
      const response = await apiRequest("POST", "/api/generate/audio", data);
      return response.json();
    },
    onSuccess: (data) => {
      setGeneratingAudio(true);
      setAudioProgress(0);

      const interval = setInterval(() => {
        setAudioProgress(prev => {
          if (prev >= 100) {
            clearInterval(interval);
            setGeneratingAudio(false);
            // Èò≤Ë≠∑ÊÄßÊ™¢Êü•ÔºöÁ¢∫‰øù data.data Â≠òÂú®
            if (data?.data?.audioUrl) {
              setGeneratedAudio(data.data.audioUrl);
              setGeneratedAudioId(data.data.id);
              toast({
                title: "Ë™ûÈü≥ÁîüÊàêÂÆåÊàê",
                description: "ÊÇ®ÁöÑË™ûÈü≥ÂÖßÂÆπÂ∑≤Ê∫ñÂÇôÂ•Ω",
              });
            } else {
              toast({
                title: "Ë™ûÈü≥ÁîüÊàêÂ§±Êïó",
                description: "ÂõûÊáâÊ†ºÂºèÈåØË™§ÔºåË´ãÁ®çÂæåÈáçË©¶",
                variant: "destructive",
              });
            }
            return 100;
          }
          return prev + 10;
        });
      }, 300);

      queryClient.invalidateQueries({ queryKey: ["/api/content"] });
    },
    onError: () => {
      toast({
        title: "ÁîüÊàêÂ§±Êïó",
        description: "Ë´ãÁ®çÂæåÈáçË©¶",
        variant: "destructive",
      });
      setGeneratingAudio(false);
    },
  });

  const generateVideoMutation = useMutation({
    mutationFn: async (data: InsertGeneratedContent) => {
      const response = await apiRequest("POST", "/api/generate/video", data);
      return response.json();
    },
    onSuccess: (data) => {
      setGeneratingVideo(true);
      setVideoProgress(0);

      const taskCode = data.data.taskCode;
      console.log(`üé¨ ÈñãÂßãÁõ£ÊéßÂΩ±ÁâáÁîüÊàêÈÄ≤Â∫¶: ${taskCode}`);

      // ÁúüÊ≠£ÁöÑÈÄ≤Â∫¶ËøΩËπ§ - Â¢ûÂä†ÈáçË©¶Ë®àÊï∏ÂíåÊõ¥Èï∑ÁöÑÁ≠âÂæÖÊôÇÈñì
      let retryCount = 0;
      const maxRetries = 60; // ÊúÄÂ§öÈáçË©¶ 60 Ê¨° (Á¥Ñ 5 ÂàÜÈêò)
      
      const checkProgress = async () => {
        try {
          const statusResponse = await apiRequest("GET", `/api/video/query?code=${taskCode}`);
          const statusData = await statusResponse.json();

          console.log(`Face2Face ÂõûÊáâ (ÈáçË©¶ ${retryCount}/${maxRetries}):`, statusData);

          // Face2Face ÂÆπÂô®ÁöÑÂõûÊáâÊ†ºÂºè: { code: 10000, data: {...}, msg: "...", success: true }
          if (statusData.code === 10000) {
            const data = statusData.data;
            const status = data.status;
            const progress = data.progress || 0;

            setVideoProgress(progress);
            retryCount = 0; // ÈáçÁΩÆÈáçË©¶Ë®àÊï∏

            if (status === 2 && data.result) {
              // ÂΩ±ÁâáÁîüÊàêÂÆåÊàê (status === 2 Ë°®Á§∫ÂÆåÊàê)
              setGeneratingVideo(false);
              setVideoProgress(100);
              setGeneratedVideo(data.video_url || `/videos/${data.result}`);
              setGeneratedVideoId(taskCode);
              toast({
                title: "ÂΩ±ÁâáÁîüÊàêÂÆåÊàê",
                description: "ÊÇ®ÁöÑ AI ÂΩ±ÁâáÂ∑≤Ê∫ñÂÇôÂ•Ω",
              });
              queryClient.invalidateQueries({ queryKey: ["/api/content"] });
              return; // ÂÅúÊ≠¢Ê™¢Êü•
            } else if (status === 'failed' || status === -1) {
              // ÂΩ±ÁâáÁîüÊàêÂ§±Êïó
              setGeneratingVideo(false);
              toast({
                title: "ÂΩ±ÁâáÁîüÊàêÂ§±Êïó",
                description: "Ë´ãÁ®çÂæåÈáçË©¶",
                variant: "destructive",
              });
              return; // ÂÅúÊ≠¢Ê™¢Êü•
            }

            // ÁπºÁ∫åÊ™¢Êü•ÈÄ≤Â∫¶
            setTimeout(checkProgress, 3000); // 3 ÁßíÂæåÂÜçÊ¨°Ê™¢Êü•
          } else if (statusData.code === 10004) {
            // ‰ªªÂãô‰∏çÂ≠òÂú®ÔºåÂèØËÉΩÂ∑≤ÂÆåÊàêÊàñÈÇÑÂú®ËôïÁêÜ‰∏≠
            retryCount++;
            console.log(`‰ªªÂãôÊö´ÊôÇÊü•‰∏çÂà∞ (ÈáçË©¶ ${retryCount}/${maxRetries})ÔºåÂèØËÉΩÈÇÑÂú®ËôïÁêÜ‰∏≠...`);
            
            // Ê™¢Êü•ÊòØÂê¶Ë∂ÖÈÅéÊúÄÂ§ßÈáçË©¶Ê¨°Êï∏
            if (retryCount >= maxRetries) {
              console.log('ÈÅîÂà∞ÊúÄÂ§ßÈáçË©¶Ê¨°Êï∏ÔºåÊ™¢Êü•Ë≥áÊñôÂ∫´ÁãÄÊÖã...');
              
              try {
                // Âæû taskCode ÊèêÂèñÂÖßÂÆπ ID
                const contentIdMatch = taskCode.match(/task_(\d+)_/);
                if (contentIdMatch) {
                  const contentId = contentIdMatch[1];
                  
                  // Ê™¢Êü•Ë≥áÊñôÂ∫´‰∏≠ÁöÑÂÖßÂÆπÁãÄÊÖã
                  const contentResponse = await apiRequest("GET", `/api/content/${contentId}`);
                  const contentData = await contentResponse.json();
                  
                  if (contentData.success && contentData.data.status === "completed") {
                    // ‰ªªÂãôÂ∑≤Âú®Ë≥áÊñôÂ∫´‰∏≠Ê®ôË®òÁÇ∫ÂÆåÊàê
                    setGeneratingVideo(false);
                    setVideoProgress(100);
                    setGeneratedVideo(contentData.data.outputPath);
                    setGeneratedVideoId(contentData.data.id);
                    toast({
                      title: "ÂΩ±ÁâáÁîüÊàêÂÆåÊàê",
                      description: "ÊÇ®ÁöÑ AI ÂΩ±ÁâáÂ∑≤Ê∫ñÂÇôÂ•Ω",
                    });
                    queryClient.invalidateQueries({ queryKey: ["/api/content"] });
                    return;
                  } else if (contentData.data.status === "failed") {
                    // ‰ªªÂãôÂ§±Êïó
                    setGeneratingVideo(false);
                    toast({
                      title: "ÂΩ±ÁâáÁîüÊàêÂ§±Êïó",
                      description: "Ë´ãÁ®çÂæåÈáçË©¶",
                      variant: "destructive",
                    });
                    return;
                  }
                }
              } catch (error) {
                console.error('Ê™¢Êü•Ë≥áÊñôÂ∫´ÁãÄÊÖãÂ§±Êïó:', error);
              }
              
              // Â¶ÇÊûúË≥áÊñôÂ∫´‰∏≠ÈÇÑÊòØ processing ÁãÄÊÖãÔºåÂÅúÊ≠¢Áõ£Êéß
              setGeneratingVideo(false);
              toast({
                title: "Áõ£ÊéßË∂ÖÊôÇ",
                description: "ÂΩ±ÁâáÂèØËÉΩÈÇÑÂú®ÁîüÊàê‰∏≠ÔºåË´ãÁ®çÂæåÂà∞‰ΩúÂìÅÁÆ°ÁêÜÊü•Áúã",
                variant: "destructive",
              });
              return;
            }
            
            // ÁπºÁ∫åÂòóË©¶Ôºå‰ΩÜÈñìÈöîÊôÇÈñìÊõ¥Èï∑
            setTimeout(checkProgress, 5000); // 5 ÁßíÂæåÂÜçÊ¨°Ê™¢Êü•
          } else {
            // ÂÖ∂‰ªñÈåØË™§ÔºåÁπºÁ∫åÂòóË©¶
            retryCount++;
            console.log(`Êü•Ë©¢Â§±Êïó (ÈáçË©¶ ${retryCount}/${maxRetries}):`, statusData.msg);
            
            if (retryCount >= maxRetries) {
              setGeneratingVideo(false);
              toast({
                title: "Áõ£ÊéßË∂ÖÊôÇ",
                description: "ÁÑ°Ê≥ïÁç≤ÂèñÂΩ±ÁâáÁîüÊàêÁãÄÊÖãÔºåË´ãÁ®çÂæåÂà∞‰ΩúÂìÅÁÆ°ÁêÜÊü•Áúã",
                variant: "destructive",
              });
              return;
            }
            
            setTimeout(checkProgress, 5000); // 5 ÁßíÂæåÂÜçÊ¨°Ê™¢Êü•
          }
        } catch (error) {
          retryCount++;
          console.error(`Ê™¢Êü•ÂΩ±ÁâáÁîüÊàêÈÄ≤Â∫¶Â§±Êïó (ÈáçË©¶ ${retryCount}/${maxRetries}):`, error);
          
          if (retryCount >= maxRetries) {
            setGeneratingVideo(false);
            toast({
              title: "Áõ£ÊéßË∂ÖÊôÇ",
              description: "Á∂≤Ë∑ØÈÄ£Êé•ÂïèÈ°åÔºåË´ãÁ®çÂæåÂà∞‰ΩúÂìÅÁÆ°ÁêÜÊü•Áúã",
              variant: "destructive",
            });
            return;
          }
          
          // ÁπºÁ∫åÂòóË©¶
          setTimeout(checkProgress, 5000); // 5 ÁßíÂæåÂÜçÊ¨°Ê™¢Êü•
        }
      };

      // ÈñãÂßãÊ™¢Êü•ÈÄ≤Â∫¶
      setTimeout(checkProgress, 5000); // 5 ÁßíÂæåÈñãÂßãÁ¨¨‰∏ÄÊ¨°Ê™¢Êü•

      queryClient.invalidateQueries({ queryKey: ["/api/content"] });
    },
    onError: () => {
      toast({
        title: "ÁîüÊàêÂ§±Êïó",
        description: "Ë´ãÁ®çÂæåÈáçË©¶",
        variant: "destructive",
      });
      setGeneratingVideo(false);
    },
  });

  const handleGenerateAudio = () => {
    if (!inputText && voiceGenerationType === "basic_tts") {
      toast({
        title: "Ë´ãËº∏ÂÖ•ÊñáÊú¨",
        description: "TTS ÁîüÊàêÈúÄË¶ÅËº∏ÂÖ•ÊñáÊú¨ÂÖßÂÆπ",
        variant: "destructive",
      });
      return;
    }

    if (voiceGenerationType === "voice_clone" && !referenceAudio) {
      toast({
        title: "Ë´ã‰∏äÂÇ≥ÂèÉËÄÉÈü≥È†ª",
        description: "ÂèÉËÄÉÈü≥È†ªÁîüÊàêÈúÄË¶Å‰∏äÂÇ≥Èü≥È†ªÊñá‰ª∂",
        variant: "destructive",
      });
      return;
    }

    generateAudioMutation.mutate({
      inputText: voiceGenerationType === "basic_tts" ? inputText : "",
      emotion,
      type: "audio",
      voiceSource: voiceGenerationType === "basic_tts" ? "model" : "reference",
      provider: selectedTTSProvider,
      ttsModel: selectedTTSModel,
      referenceAudio: referenceAudio,
      // MiniMax ÈÄ≤ÈöéË®≠ÂÆö
      minimaxEmotion,
      minimaxVolume: minimaxVolume[0],
      minimaxSpeed: minimaxSpeed[0],
      minimaxPitch: minimaxPitch[0],
      // ATEN ÈÄ≤ÈöéË®≠ÂÆö
      atenPitch: atenPitch[0],
      atenRate: atenRate[0],
      atenVolume: atenVolume[0],
      atenSilenceScale: atenSilenceScale[0],
    });
  };

  const handleGenerateVideo = () => {
    if (!selectedCharacterModelId) {
      toast({
        title: "Ë´ãÈÅ∏Êìá‰∫∫Áâ©Ê®°Áâπ",
        description: "ÂΩ±ÁâáÁîüÊàêÈúÄË¶ÅÈÅ∏Êìá‰∫∫Áâ©Ê®°Áâπ",
        variant: "destructive",
      });
      return;
    }

    if (!inputText && voiceGenerationType === "basic_tts") {
      toast({
        title: "Ë´ãËº∏ÂÖ•ÊñáÊú¨",
        description: "TTS ÁîüÊàêÈúÄË¶ÅËº∏ÂÖ•ÊñáÊú¨ÂÖßÂÆπ",
        variant: "destructive",
      });
      return;
    }

    if (voiceGenerationType === "voice_clone" && !referenceAudio) {
      toast({
        title: "Ë´ã‰∏äÂÇ≥ÂèÉËÄÉÈü≥È†ª",
        description: "ÂèÉËÄÉÈü≥È†ªÁîüÊàêÈúÄË¶Å‰∏äÂÇ≥Èü≥È†ªÊñá‰ª∂",
        variant: "destructive",
      });
      return;
    }

    const videoData: any = {
      modelId: parseInt(selectedCharacterModelId), // ËΩâÊèõÁÇ∫Êï∏Â≠ó
      inputText: voiceGenerationType === "basic_tts" ? inputText : "",
      emotion,
      type: "video",
      voiceSource: voiceGenerationType === "basic_tts" ? "model" : "reference",
      provider: selectedTTSProvider,
      ttsModel: selectedTTSModel,
      // MiniMax ÈÄ≤ÈöéË®≠ÂÆö
      minimaxEmotion,
      minimaxVolume: minimaxVolume[0],
      minimaxSpeed: minimaxSpeed[0],
      minimaxPitch: minimaxPitch[0],
      // ATEN ÈÄ≤ÈöéË®≠ÂÆö
      atenPitch: atenPitch[0],
      atenRate: atenRate[0],
      atenVolume: atenVolume[0],
      atenSilenceScale: atenSilenceScale[0],
    };

    // Â¶ÇÊûúÊúâÂèÉËÄÉÈü≥È†ªÔºåÊ∑ªÂä†Âà∞Êï∏Êìö‰∏≠
    if (referenceAudio) {
      videoData.referenceAudio = referenceAudio;
    }

    generateVideoMutation.mutate(videoData);
  };

  return (
    <div className="space-y-8">
      <div>
        <h1 className="text-3xl font-bold text-gray-900 mb-2">ÂΩ±Èü≥ÁîüÊàêÂô®</h1>
        <p className="text-gray-600">‰ΩøÁî®AIÊ®°ÁâπÂâµÂª∫Â∞àÊ•≠ÁöÑÂΩ±ÁâáÂíåË™ûÈü≥ÂÖßÂÆπ</p>
      </div>

      <Tabs defaultValue="audio" className="w-full">
        <TabsList className="grid w-full grid-cols-2">
          <TabsTrigger value="audio">Ë™ûÈü≥ÁîüÊàê</TabsTrigger>
          <TabsTrigger value="video">ÂΩ±ÁâáÁîüÊàê</TabsTrigger>
        </TabsList>

        <TabsContent value="audio" className="space-y-6">
          <Card>
            <CardContent className="p-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-6">Ë™ûÈü≥ÁîüÊàê</h3>

              <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <div className="xl:col-span-2 space-y-6">
                  {/* Ë™ûÈü≥ÁîüÊàêÊñπÂºèÈÅ∏Êìá */}
                  <div>
                    <Label className="text-base font-semibold">Ë™ûÈü≥ÁîüÊàêÊñπÂºè</Label>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                      <Card
                        className={`cursor-pointer transition-all ${voiceGenerationType === "basic_tts"
                            ? 'ring-2 ring-primary border-primary'
                            : 'hover:shadow-md'
                          }`}
                        onClick={() => setVoiceGenerationType("basic_tts")}
                      >
                        <CardContent className="p-4">
                          <h4 className="font-medium text-gray-900 mb-1">Âü∫Á§éTTS</h4>
                          <p className="text-xs text-gray-600">‰ΩøÁî®È†êË®≠ËÅ≤Èü≥Âø´ÈÄüËΩâÊèõÊñáÂ≠óÁÇ∫Ë™ûÈü≥</p>
                        </CardContent>
                      </Card>

                      <Card
                        className={`cursor-pointer transition-all ${voiceGenerationType === "voice_model"
                            ? 'ring-2 ring-primary border-primary'
                            : 'hover:shadow-md'
                          }`}
                        onClick={() => setVoiceGenerationType("voice_model")}
                      >
                        <CardContent className="p-4">
                          <h4 className="font-medium text-gray-900 mb-1">ËÅ≤Èü≥Ê®°Áâπ</h4>
                          <p className="text-xs text-gray-600">‰ΩøÁî®Â∑≤Ë®ìÁ∑¥ÁöÑËÅ≤Èü≥Ê®°ÁâπÁîüÊàêË™ûÈü≥</p>
                        </CardContent>
                      </Card>

                      <Card
                        className={`cursor-pointer transition-all ${voiceGenerationType === "voice_clone"
                            ? 'ring-2 ring-primary border-primary'
                            : 'hover:shadow-md'
                          }`}
                        onClick={() => setVoiceGenerationType("voice_clone")}
                      >
                        <CardContent className="p-4">
                          <h4 className="font-medium text-gray-900 mb-1">ËÅ≤Èü≥ÂÖãÈöÜ</h4>
                          <p className="text-xs text-gray-600">‰∏äÂÇ≥ÂèÉËÄÉÈü≥È†ªÂç≥ÊôÇÂÖãÈöÜËÅ≤Èü≥ÁâπÂæµ</p>
                        </CardContent>
                      </Card>
                    </div>
                  </div>

                  {/* ÊñáÊú¨Ëº∏ÂÖ• (Âü∫Á§éTTS Ê®°Âºè) */}
                  {voiceGenerationType === "basic_tts" && (
                    <div>
                      <Label htmlFor="inputText">Ëº∏ÂÖ•ÊñáÊú¨</Label>
                      <Textarea
                        id="inputText"
                        placeholder="Ëº∏ÂÖ•Ë¶ÅËΩâÊèõÁöÑÊñáÊú¨ÂÖßÂÆπ..."
                        rows={4}
                        value={inputText}
                        onChange={(e) => setInputText(e.target.value)}
                        className="resize-none mt-2"
                      />
                    </div>
                  )}

                  {/* TTS Êèê‰æõÂïÜÈÅ∏Êìá (Âü∫Á§éTTS Ê®°Âºè) */}
                  {voiceGenerationType === "basic_tts" && (
                    <div className="space-y-4">
                      <div>
                        <Label className="text-base font-semibold">ÈÅ∏Êìá TTS Êèê‰æõÂïÜ</Label>
                        <Select value={selectedTTSProvider} onValueChange={(value) => {
                          setSelectedTTSProvider(value);
                          // Ë®≠ÁΩÆË©≤Êèê‰æõÂïÜÁöÑÈ†êË®≠ËÅ≤Èü≥
                          const defaultVoice = ttsVoices[value as keyof typeof ttsVoices]?.[0]?.id || "";
                          setSelectedTTSModel(defaultVoice);
                        }}>
                          <SelectTrigger className="mt-2">
                            <SelectValue placeholder="ÈÅ∏Êìá TTS Êèê‰æõÂïÜ" />
                          </SelectTrigger>
                          <SelectContent>
                            {ttsProviders.map((provider) => (
                              <SelectItem key={provider.id} value={provider.id}>
                                <div className="flex flex-col items-start w-full">
                                  <span className="font-medium text-left">{provider.name}</span>
                                  <span className="text-xs text-gray-500 text-left">{provider.description}</span>
                                </div>
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>

                      {selectedTTSProvider && (
                        <div>
                          <Label className="text-base font-semibold">ÈÅ∏ÊìáËÅ≤Èü≥</Label>
                          <Select value={selectedTTSModel} onValueChange={setSelectedTTSModel}>
                            <SelectTrigger className="mt-2">
                              <SelectValue placeholder="ÈÅ∏ÊìáËÅ≤Èü≥" />
                            </SelectTrigger>
                            <SelectContent>
                              {ttsVoices[selectedTTSProvider as keyof typeof ttsVoices]?.map((voice) => (
                                <SelectItem key={voice.id} value={voice.id}>
                                  <div className="flex items-center space-x-2">
                                    <span className="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">
                                      {voice.language}
                                    </span>
                                    <span>{voice.name}</span>
                                  </div>
                                </SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                        </div>
                      )}

                      {/* MiniMax ÈÄ≤ÈöéË®≠ÂÆö */}
                      {selectedTTSProvider === "minimax" && (
                        <div className="space-y-3">
                          <Collapsible open={showMinimaxAdvanced} onOpenChange={setShowMinimaxAdvanced}>
                            <CollapsibleTrigger asChild>
                              <Button variant="outline" className="w-full">
                                <Settings className="mr-2 h-4 w-4" />
                                <Zap className="mr-2 h-4 w-4 text-yellow-500" />
                                MiniMax ÈÄ≤ÈöéË®≠ÂÆö
                                {showMinimaxAdvanced ? " (Â∑≤Â±ïÈñã)" : " (ÈªûÊìäÂ±ïÈñã)"}
                              </Button>
                            </CollapsibleTrigger>
                            <CollapsibleContent className="space-y-4 mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                              {/* ÊÉÖÁ∑íÈÅ∏Êìá */}
                              <div className="space-y-2">
                                <Label className="text-sm font-medium">ÊÉÖÁ∑íË°®ÈÅî</Label>
                                <Select value={minimaxEmotion} onValueChange={setMinimaxEmotion}>
                                  <SelectTrigger>
                                    <SelectValue placeholder="ÈÅ∏ÊìáÊÉÖÁ∑í" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    {minimaxEmotions.map((emotion) => (
                                      <SelectItem key={emotion.id} value={emotion.id}>
                                        {emotion.name}
                                      </SelectItem>
                                    ))}
                                  </SelectContent>
                                </Select>
                              </div>

                              {/* Èü≥ÈáèÊéßÂà∂ */}
                              <div className="space-y-2">
                                <Label className="text-sm font-medium">Èü≥Èáè: {minimaxVolume[0].toFixed(1)}</Label>
                                <Slider
                                  value={minimaxVolume}
                                  onValueChange={setMinimaxVolume}
                                  max={2.0}
                                  min={0.1}
                                  step={0.1}
                                  className="w-full"
                                />
                                <div className="flex justify-between text-xs text-gray-500">
                                  <span>0.1 (ÊúÄÂ∞è)</span>
                                  <span>2.0 (ÊúÄÂ§ß)</span>
                                </div>
                              </div>

                              {/* Ë™ûÈÄüÊéßÂà∂ */}
                              <div className="space-y-2">
                                <Label className="text-sm font-medium">Ë™ûÈÄü: {minimaxSpeed[0].toFixed(1)}</Label>
                                <Slider
                                  value={minimaxSpeed}
                                  onValueChange={setMinimaxSpeed}
                                  max={2.0}
                                  min={0.5}
                                  step={0.1}
                                  className="w-full"
                                />
                                <div className="flex justify-between text-xs text-gray-500">
                                  <span>0.5 (ÊÖ¢)</span>
                                  <span>2.0 (Âø´)</span>
                                </div>
                              </div>

                              {/* Èü≥Ë™øÊéßÂà∂ */}
                              <div className="space-y-2">
                                <Label className="text-sm font-medium">Èü≥Ë™ø: {minimaxPitch[0] > 0 ? '+' : ''}{minimaxPitch[0]}</Label>
                                <Slider
                                  value={minimaxPitch}
                                  onValueChange={setMinimaxPitch}
                                  max={12}
                                  min={-12}
                                  step={1}
                                  className="w-full"
                                />
                                <div className="flex justify-between text-xs text-gray-500">
                                  <span>-12 (‰Ωé)</span>
                                  <span>+12 (È´ò)</span>
                                </div>
                              </div>
                            </CollapsibleContent>
                          </Collapsible>
                        </div>
                      )}

                      {/* ATEN ÈÄ≤ÈöéË®≠ÂÆö */}
                      {selectedTTSProvider === "aten" && (
                        <div className="space-y-3">
                          <Collapsible open={showATENAdvanced} onOpenChange={setShowATENAdvanced}>
                            <CollapsibleTrigger asChild>
                              <Button variant="outline" className="w-full">
                                <Settings className="mr-2 h-4 w-4" />
                                ATEN ÈÄ≤ÈöéË™ûÈü≥Ë®≠ÂÆö
                                {showATENAdvanced ? " (Â∑≤Â±ïÈñã)" : " (ÈªûÊìäÂ±ïÈñã)"}
                              </Button>
                            </CollapsibleTrigger>
                            <CollapsibleContent className="space-y-4 mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                              <div className="space-y-4">
                                <Label className="text-base font-semibold">Á≤æÁ¥∞Ë™ûÈü≥ÂèÉÊï∏Ë™øÊï¥</Label>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                  {/* Èü≥Ë™ø */}
                                  <div className="space-y-2">
                                    <div className="flex justify-between">
                                      <Label className="text-sm font-medium">Èü≥Ë™ø (Pitch)</Label>
                                      <span className="text-sm text-muted-foreground">
                                        {atenPitch[0] > 0 ? '+' : ''}{atenPitch[0].toFixed(1)}st
                                      </span>
                                    </div>
                                    <Slider
                                      value={atenPitch}
                                      onValueChange={setAtenPitch}
                                      min={-2}
                                      max={2}
                                      step={0.1}
                                      className="w-full"
                                    />
                                    <div className="text-xs text-muted-foreground">
                                      Ë™øÊï¥ËÅ≤Èü≥ÁöÑÂü∫È†ªÈ´ò‰Ωé (-2st ~ +2st)
                                    </div>
                                  </div>

                                  {/* Ë™ûÈÄü */}
                                  <div className="space-y-2">
                                    <div className="flex justify-between">
                                      <Label className="text-sm font-medium">Ë™ûÈÄü (Rate)</Label>
                                      <span className="text-sm text-muted-foreground">
                                        {atenRate[0].toFixed(1)}x
                                      </span>
                                    </div>
                                    <Slider
                                      value={atenRate}
                                      onValueChange={setAtenRate}
                                      min={0.8}
                                      max={1.2}
                                      step={0.1}
                                      className="w-full"
                                    />
                                    <div className="text-xs text-muted-foreground">
                                      Ë™øÊï¥Ë™™Ë©±ÈÄüÂ∫¶ (0.8x ~ 1.2x)
                                    </div>
                                  </div>

                                  {/* Èü≥Èáè */}
                                  <div className="space-y-2">
                                    <div className="flex justify-between">
                                      <Label className="text-sm font-medium">Èü≥Èáè (Volume)</Label>
                                      <span className="text-sm text-muted-foreground">
                                        {atenVolume[0] > 0 ? '+' : ''}{atenVolume[0].toFixed(1)}dB
                                      </span>
                                    </div>
                                    <Slider
                                      value={atenVolume}
                                      onValueChange={setAtenVolume}
                                      min={-6}
                                      max={6}
                                      step={0.5}
                                      className="w-full"
                                    />
                                    <div className="text-xs text-muted-foreground">
                                      Ë™øÊï¥Èü≥ÈáèÂ§ßÂ∞è (-6dB ~ +6dB)
                                    </div>
                                  </div>

                                  {/* ÂÅúÈ†ìÊôÇÈñì */}
                                  <div className="space-y-2">
                                    <div className="flex justify-between">
                                      <Label className="text-sm font-medium">ÂÅúÈ†ìÊôÇÈñì (Silence Scale)</Label>
                                      <span className="text-sm text-muted-foreground">
                                        {atenSilenceScale[0].toFixed(1)}x
                                      </span>
                                    </div>
                                    <Slider
                                      value={atenSilenceScale}
                                      onValueChange={setAtenSilenceScale}
                                      min={0.5}
                                      max={3.0}
                                      step={0.1}
                                      className="w-full"
                                    />
                                    <div className="text-xs text-muted-foreground">
                                      Ë™øÊï¥Ê≥®Èü≥Á¨¶ËôüÂÅúÈ†ìÊôÇÈñì (0.5x ~ 3.0x)
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </CollapsibleContent>
                          </Collapsible>
                        </div>
                      )}

                    </div>
                  )}

                  {/* ÂèÉËÄÉÈü≥È†ª‰∏äÂÇ≥ */}
                  {voiceGenerationType === "voice_clone" && (
                    <div>
                      <Label className="text-base font-semibold">‰∏äÂÇ≥ÂèÉËÄÉÈü≥È†ª</Label>
                      <div className="mt-3">
                        <input
                          type="file"
                          accept="audio/*"
                          onChange={(e) => setReferenceAudio(e.target.files?.[0] || null)}
                          className="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-primary file:text-primary-foreground
                            hover:file:bg-primary/90"
                        />
                        {referenceAudio && (
                          <p className="mt-2 text-sm text-gray-600">
                            Â∑≤ÈÅ∏Êìá: {referenceAudio.name}
                          </p>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                <div className="space-y-4">
                  <Button
                    className="w-full"
                    onClick={handleGenerateAudio}
                    disabled={generatingAudio || generateAudioMutation.isPending}
                  >
                    <MicOff className="mr-2 h-4 w-4" />
                    {generatingAudio ? "ÁîüÊàê‰∏≠..." : "ÁîüÊàêË™ûÈü≥"}
                  </Button>

                  {generatingAudio && (
                    <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="flex items-center space-x-3 mb-2">
                        <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                        <span className="text-blue-700 text-sm font-medium">Ê≠£Âú®ÁîüÊàêË™ûÈü≥...</span>
                      </div>
                      <Progress value={audioProgress} className="h-2" />
                    </div>
                  )}

                  {generatedAudio && (
                    <div className="p-4 bg-gray-50 rounded-lg">
                      <div className="flex items-center justify-between mb-3">
                        <span className="text-sm font-medium text-gray-700">Ë™ûÈü≥È†êË¶Ω</span>
                        <div className="flex items-center space-x-2">
                          {generatedAudioId && (
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => toggleFavoriteMutation.mutate({ id: generatedAudioId, isFavorite: true })}
                              className="text-gray-400 hover:text-yellow-500"
                            >
                              <Star className="h-4 w-4" />
                            </Button>
                          )}
                          <Button variant="ghost" size="sm">
                            <Download className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                      <AudioPlayer src={generatedAudio} />
                    </div>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="video" className="space-y-6">
          <Card>
            <CardContent className="p-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-6">ÂΩ±ÁâáÁîüÊàê (ÂåÖÂê´Ë™ûÈü≥)</h3>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="space-y-6">
                  {/* ‰∫∫Áâ©Ê®°ÁâπÈÅ∏Êìá */}
                  <div>
                    <Label className="text-base font-semibold">ÈÅ∏Êìá‰∫∫Áâ©Ê®°Áâπ</Label>
                    <Select value={selectedCharacterModelId} onValueChange={setSelectedCharacterModelId}>
                      <SelectTrigger className="mt-2">
                        <SelectValue placeholder="ÈÅ∏Êìá‰∫∫Áâ©Ê®°Áâπ" />
                      </SelectTrigger>
                      <SelectContent>
                        {characterModels.map((model: Model) => (
                          <SelectItem key={model.id} value={model.id.toString()}>
                            <div className="flex items-center space-x-2">
                              <span className="px-2 py-1 rounded text-xs bg-green-100 text-green-700">
                                ‰∫∫Áâ©
                              </span>
                              <span>{model.name}</span>
                            </div>
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  {/* Ë™ûÈü≥ÁîüÊàêÊñπÂºèÈÅ∏Êìá */}
                  <div>
                    <Label className="text-base font-semibold">Ë™ûÈü≥ÁîüÊàêÊñπÂºè</Label>
                    <div className="grid grid-cols-1 gap-3 mt-3">
                      <Card
                        className={`cursor-pointer transition-all ${voiceGenerationType === "basic_tts"
                            ? 'ring-2 ring-primary border-primary'
                            : 'hover:shadow-md'
                          }`}
                        onClick={() => setVoiceGenerationType("basic_tts")}
                      >
                        <CardContent className="p-4">
                          <h4 className="font-medium text-gray-900 mb-1">Âü∫Á§éTTS</h4>
                          <p className="text-xs text-gray-600">‰ΩøÁî®È†êË®≠ËÅ≤Èü≥Âø´ÈÄüËΩâÊèõÊñáÂ≠óÁÇ∫Ë™ûÈü≥</p>
                        </CardContent>
                      </Card>

                      <Card
                        className={`cursor-pointer transition-all ${voiceGenerationType === "voice_model"
                            ? 'ring-2 ring-primary border-primary'
                            : 'hover:shadow-md'
                          }`}
                        onClick={() => setVoiceGenerationType("voice_model")}
                      >
                        <CardContent className="p-4">
                          <h4 className="font-medium text-gray-900 mb-1">ËÅ≤Èü≥Ê®°Áâπ</h4>
                          <p className="text-xs text-gray-600">‰ΩøÁî®Â∑≤Ë®ìÁ∑¥ÁöÑËÅ≤Èü≥Ê®°ÁâπÁîüÊàêË™ûÈü≥</p>
                        </CardContent>
                      </Card>

                      <Card
                        className={`cursor-pointer transition-all ${voiceGenerationType === "voice_clone"
                            ? 'ring-2 ring-primary border-primary'
                            : 'hover:shadow-md'
                          }`}
                        onClick={() => setVoiceGenerationType("voice_clone")}
                      >
                        <CardContent className="p-4">
                          <h4 className="font-medium text-gray-900 mb-1">ËÅ≤Èü≥ÂÖãÈöÜ</h4>
                          <p className="text-xs text-gray-600">‰∏äÂÇ≥ÂèÉËÄÉÈü≥È†ªÂç≥ÊôÇÂÖãÈöÜËÅ≤Èü≥ÁâπÂæµ</p>
                        </CardContent>
                      </Card>
                    </div>
                  </div>

                  {/* ÊñáÊú¨Ëº∏ÂÖ• (Âü∫Á§éTTS Ê®°Âºè) */}
                  {voiceGenerationType === "basic_tts" && (
                    <div>
                      <Label htmlFor="videoInputText">Ëº∏ÂÖ•ÊñáÊú¨</Label>
                      <Textarea
                        id="videoInputText"
                        placeholder="Ëº∏ÂÖ•Ë¶ÅËΩâÊèõÁöÑÊñáÊú¨ÂÖßÂÆπ..."
                        rows={4}
                        value={inputText}
                        onChange={(e) => setInputText(e.target.value)}
                        className="resize-none mt-2"
                      />
                    </div>
                  )}

                  {/* TTS Êèê‰æõÂïÜÈÅ∏Êìá (Âü∫Á§éTTS Ê®°Âºè) */}
                  {voiceGenerationType === "basic_tts" && (
                    <div className="space-y-4">
                      <div>
                        <Label className="text-base font-semibold">ÈÅ∏Êìá TTS Êèê‰æõÂïÜ</Label>
                        <Select value={selectedTTSProvider} onValueChange={(value) => {
                          setSelectedTTSProvider(value);
                          // Ë®≠ÁΩÆË©≤Êèê‰æõÂïÜÁöÑÈ†êË®≠ËÅ≤Èü≥
                          const defaultVoice = ttsVoices[value as keyof typeof ttsVoices]?.[0]?.id || "";
                          setSelectedTTSModel(defaultVoice);
                        }}>
                          <SelectTrigger className="mt-2">
                            <SelectValue placeholder="ÈÅ∏Êìá TTS Êèê‰æõÂïÜ" />
                          </SelectTrigger>
                          <SelectContent>
                            {ttsProviders.map((provider) => (
                              <SelectItem key={provider.id} value={provider.id}>
                                <div className="flex flex-col items-start w-full">
                                  <span className="font-medium text-left">{provider.name}</span>
                                  <span className="text-xs text-gray-500 text-left">{provider.description}</span>
                                </div>
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>

                      {selectedTTSProvider && (
                        <div>
                          <Label className="text-base font-semibold">ÈÅ∏ÊìáËÅ≤Èü≥</Label>
                          <Select value={selectedTTSModel} onValueChange={setSelectedTTSModel}>
                            <SelectTrigger className="mt-2">
                              <SelectValue placeholder="ÈÅ∏ÊìáËÅ≤Èü≥" />
                            </SelectTrigger>
                            <SelectContent>
                              {ttsVoices[selectedTTSProvider as keyof typeof ttsVoices]?.map((voice) => (
                                <SelectItem key={voice.id} value={voice.id}>
                                  <div className="flex items-center space-x-2">
                                    <span className="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">
                                      {voice.language}
                                    </span>
                                    <span>{voice.name}</span>
                                  </div>
                                </SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                        </div>
                      )}

                      {/* MiniMax ÈÄ≤ÈöéË®≠ÂÆö (ÂΩ±ÁâáÁîüÊàê) */}
                      {selectedTTSProvider === "minimax" && (
                        <div className="space-y-3">
                          <Collapsible open={showMinimaxAdvanced} onOpenChange={setShowMinimaxAdvanced}>
                            <CollapsibleTrigger asChild>
                              <Button variant="outline" className="w-full">
                                <Settings className="mr-2 h-4 w-4" />
                                <Zap className="mr-2 h-4 w-4 text-yellow-500" />
                                MiniMax ÈÄ≤ÈöéË®≠ÂÆö
                                {showMinimaxAdvanced ? " (Â∑≤Â±ïÈñã)" : " (ÈªûÊìäÂ±ïÈñã)"}
                              </Button>
                            </CollapsibleTrigger>
                            <CollapsibleContent className="space-y-4 mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                              {/* ÊÉÖÁ∑íÈÅ∏Êìá */}
                              <div className="space-y-2">
                                <Label className="text-sm font-medium">ÊÉÖÁ∑íË°®ÈÅî</Label>
                                <Select value={minimaxEmotion} onValueChange={setMinimaxEmotion}>
                                  <SelectTrigger>
                                    <SelectValue placeholder="ÈÅ∏ÊìáÊÉÖÁ∑í" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    {minimaxEmotions.map((emotion) => (
                                      <SelectItem key={emotion.id} value={emotion.id}>
                                        {emotion.name}
                                      </SelectItem>
                                    ))}
                                  </SelectContent>
                                </Select>
                              </div>

                              {/* Èü≥ÈáèÊéßÂà∂ */}
                              <div className="space-y-2">
                                <Label className="text-sm font-medium">Èü≥Èáè: {minimaxVolume[0].toFixed(1)}</Label>
                                <Slider
                                  value={minimaxVolume}
                                  onValueChange={setMinimaxVolume}
                                  max={2.0}
                                  min={0.1}
                                  step={0.1}
                                  className="w-full"
                                />
                                <div className="flex justify-between text-xs text-gray-500">
                                  <span>0.1 (ÊúÄÂ∞è)</span>
                                  <span>2.0 (ÊúÄÂ§ß)</span>
                                </div>
                              </div>

                              {/* Ë™ûÈÄüÊéßÂà∂ */}
                              <div className="space-y-2">
                                <Label className="text-sm font-medium">Ë™ûÈÄü: {minimaxSpeed[0].toFixed(1)}</Label>
                                <Slider
                                  value={minimaxSpeed}
                                  onValueChange={setMinimaxSpeed}
                                  max={2.0}
                                  min={0.5}
                                  step={0.1}
                                  className="w-full"
                                />
                                <div className="flex justify-between text-xs text-gray-500">
                                  <span>0.5 (ÊÖ¢)</span>
                                  <span>2.0 (Âø´)</span>
                                </div>
                              </div>

                              {/* Èü≥Ë™øÊéßÂà∂ */}
                              <div className="space-y-2">
                                <Label className="text-sm font-medium">Èü≥Ë™ø: {minimaxPitch[0] > 0 ? '+' : ''}{minimaxPitch[0]}</Label>
                                <Slider
                                  value={minimaxPitch}
                                  onValueChange={setMinimaxPitch}
                                  max={12}
                                  min={-12}
                                  step={1}
                                  className="w-full"
                                />
                                <div className="flex justify-between text-xs text-gray-500">
                                  <span>-12 (‰Ωé)</span>
                                  <span>+12 (È´ò)</span>
                                </div>
                              </div>
                            </CollapsibleContent>
                          </Collapsible>
                        </div>
                      )}
                    </div>
                  )}

                  {/* ÂèÉËÄÉÈü≥È†ª‰∏äÂÇ≥ */}
                  {voiceGenerationType === "voice_clone" && (
                    <div>
                      <Label className="text-base font-semibold">‰∏äÂÇ≥ÂèÉËÄÉÈü≥È†ª</Label>
                      <div className="mt-3">
                        <input
                          type="file"
                          accept="audio/*"
                          onChange={(e) => setReferenceAudio(e.target.files?.[0] || null)}
                          className="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-primary file:text-primary-foreground
                            hover:file:bg-primary/90"
                        />
                        {referenceAudio && (
                          <p className="mt-2 text-sm text-gray-600">
                            Â∑≤ÈÅ∏Êìá: {referenceAudio.name}
                          </p>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                <div className="space-y-4">
                  <Button
                    className="w-full bg-purple-500 hover:bg-purple-600"
                    onClick={handleGenerateVideo}
                    disabled={generatingVideo || generateVideoMutation.isPending}
                  >
                    <Video className="mr-2 h-4 w-4" />
                    {generatingVideo ? "ÁîüÊàê‰∏≠..." : "ÁîüÊàêÂΩ±Áâá"}
                  </Button>

                  {generatingVideo && (
                    <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
                      <div className="flex items-center space-x-3 mb-2">
                        <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-purple-600"></div>
                        <span className="text-purple-700 text-sm font-medium">Ê≠£Âú®ÁîüÊàêÂΩ±Áâá...</span>
                      </div>
                      <Progress value={videoProgress} className="h-2" />
                    </div>
                  )}

                  <div className="aspect-video bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
                    {generatedVideo ? (
                      <div className="w-full h-full">
                        <video
                          src={generatedVideo}
                          controls
                          className="w-full h-full rounded-lg object-cover"
                          onError={(e) => {
                            console.error('ÂΩ±ÁâáËºâÂÖ•Â§±Êïó:', e);
                            toast({
                              title: "ÂΩ±ÁâáËºâÂÖ•Â§±Êïó",
                              description: "Ë´ãÊ™¢Êü•ÂΩ±ÁâáÊ™îÊ°àÊòØÂê¶Â≠òÂú®",
                              variant: "destructive",
                            });
                          }}
                        >
                          ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂΩ±ÁâáÊí≠Êîæ
                        </video>
                        <div className="flex items-center justify-between mt-3">
                          <span className="text-sm font-medium text-gray-700">ÂΩ±ÁâáÈ†êË¶Ω</span>
                          <div className="flex items-center space-x-2">
                            {generatedVideoId && (
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => toggleFavoriteMutation.mutate({ id: generatedVideoId, isFavorite: true })}
                                className="text-gray-400 hover:text-yellow-500"
                              >
                                <Star className="h-4 w-4" />
                              </Button>
                            )}
                            <Button variant="ghost" size="sm">
                              <Download className="h-4 w-4" />
                            </Button>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div className="text-center">
                        <Video className="text-gray-400 h-8 w-8 mx-auto mb-2" />
                        <p className="text-gray-500 text-sm">ÂΩ±ÁâáÂ∞áÂú®Ê≠§È°ØÁ§∫</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

      </Tabs>
    </div>
  );
}
